<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Controls | Gwalia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        /* LOGIN */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #222;
            color: white;
            margin-bottom: 15px;
            width: 200px;
            text-align: center;
            font-size: 1.1em;
        }

        .btn-primary {
            background: #ff9f1c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        /* HEADER */
        .header {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* MASTER SWITCH */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e63946;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2ec4b6;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .store-status-text {
            font-size: 0.9em;
            margin-right: 10px;
            font-weight: bold;
        }

        /* INVENTORY TABLE */
        .menu-search {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #1e1e1e;
            color: white;
            margin-bottom: 20px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
        }

        .inventory-table th {
            background: #333;
            color: #ff9f1c;
            text-align: left;
            padding: 12px;
            font-size: 0.9em;
        }

        .inventory-table td {
            padding: 12px;
            border-bottom: 1px solid #333;
            vertical-align: middle;
        }

        .inventory-table tr:hover {
            background: #252525;
        }

        /* INPUTS IN TABLE */
        .tbl-input {
            width: 60px;
            padding: 8px;
            background: #121212;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }

        .tbl-btn {
            background: #2ec4b6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8em;
        }

        .tbl-btn:hover {
            opacity: 0.8;
        }

        /* Small Toggle for Table */
        .mini-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .mini-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .mini-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 34px;
        }

        .mini-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.mini-slider {
            background-color: #ff9f1c;
        }

        input:checked+.mini-slider:before {
            transform: translateX(20px);
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <h2 style="color:white; margin-bottom:20px;">Manager Access</h2>
        <input type="password" id="admin-pass" placeholder="Enter PIN">
        <button class="btn-primary" onclick="checkLogin()">Unlock Controls</button>
    </div>

    <div id="main-app" style="display:none;">

        <div class="header">
            <span style="color:#aaa;">Master Shop Switch</span>
            <div style="display:flex; align-items:center;">
                <span id="store-status-text" class="store-status-text">CLOSED</span>
                <label class="switch">
                    <input type="checkbox" id="store-toggle" onchange="toggleStore(this)">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <h2 style="color:#ff9f1c; margin-bottom: 10px;">Inventory Manager</h2>
        <input type="text" class="menu-search" id="menuSearch" placeholder="Search item..." onkeyup="renderTable()">

        <div style="overflow-x:auto;">
            <table class="inventory-table">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th style="width:70px;">Price (â‚¹)</th>
                        <th style="width:70px;">Stock</th>
                        <th style="width:60px;">Active</th>
                        <th style="width:70px;">Action</th>
                    </tr>
                </thead>
                <tbody id="menu-table-body">
                </tbody>
            </table>
        </div>
        <div style="text-align:center; color:#555; margin-top:20px;" id="loading-txt">Loading Inventory...</div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, onSnapshot, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGNfaSsDoVEn9e_EEA36J7FbtDG9Zpcww",
            authDomain: "gwalia-canteen-db.firebaseapp.com",
            projectId: "gwalia-canteen-db",
            storageBucket: "gwalia-canteen-db.firebasestorage.app",
            messagingSenderId: "609249581676",
            appId: "1:609249581676:web:9495fd520ba2681ac4d649"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allMenuItems = [];

        window.checkLogin = function () {
            if (document.getElementById('admin-pass').value === "admin123") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initManager();
            } else { alert("Wrong PIN"); }
        }

        function initManager() {
            // 1. Listen to Store Status
            onSnapshot(doc(db, "config", "store"), (docSnap) => {
                if (docSnap.exists()) {
                    const isOpen = docSnap.data().isOpen;
                    const toggle = document.getElementById('store-toggle');
                    const text = document.getElementById('store-status-text');
                    toggle.checked = isOpen;
                    text.innerText = isOpen ? "OPEN ðŸŸ¢" : "CLOSED ðŸ”´";
                    text.style.color = isOpen ? "#2ec4b6" : "#e63946";
                } else {
                    setDoc(doc(db, "config", "store"), { isOpen: true });
                }
            });

            // 2. Listen to Menu
            const q = query(collection(db, "menu_items"), orderBy("id"));
            onSnapshot(q, (snapshot) => {
                allMenuItems = [];
                snapshot.forEach(doc => allMenuItems.push(doc.data()));
                document.getElementById('loading-txt').style.display = 'none';
                renderTable();
            });
        }

        window.toggleStore = async function (checkbox) {
            await setDoc(doc(db, "config", "store"), { isOpen: checkbox.checked });
        }

        window.renderTable = function () {
            const input = document.getElementById('menuSearch').value.toLowerCase();
            const tbody = document.getElementById('menu-table-body');
            tbody.innerHTML = "";

            allMenuItems.forEach(item => {
                if (item.name.toLowerCase().includes(input)) {
                    const tr = document.createElement('tr');

                    // Stock logic: default to 9999 if not set
                    const currentStock = item.stock !== undefined ? item.stock : 9999;
                    const isAvail = item.isAvailable !== false;

                    tr.innerHTML = `
                        <td>
                            <div style="font-weight:600;">${item.name}</div>
                            <div style="font-size:0.8em; color:#777;">ID: ${item.id}</div>
                        </td>
                        <td>
                            <input type="number" id="price-${item.id}" value="${item.price}" class="tbl-input">
                        </td>
                        <td>
                            <input type="number" id="stock-${item.id}" value="${currentStock}" class="tbl-input" style="color:#ff9f1c;">
                        </td>
                        <td>
                            <label class="mini-switch">
                                <input type="checkbox" id="avail-${item.id}" ${isAvail ? 'checked' : ''}>
                                <span class="mini-slider"></span>
                            </label>
                        </td>
                        <td>
                            <button class="tbl-btn" onclick="saveRow('${item.id}')">Save</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        window.saveRow = async function (id) {
            const newPrice = document.getElementById(`price-${id}`).value;
            const newStock = document.getElementById(`stock-${id}`).value;
            const isAvail = document.getElementById(`avail-${id}`).checked;

            await updateDoc(doc(db, "menu_items", String(id)), {
                price: Number(newPrice),
                stock: Number(newStock),
                isAvailable: isAvail
            });
            alert("Updated!");
        }
    </script>
</body>

</html>