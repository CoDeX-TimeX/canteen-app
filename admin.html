<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS | Gwalia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        input {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #222;
            color: white;
            margin-bottom: 15px;
            width: 200px;
            text-align: center;
            font-size: 1.1em;
        }

        .btn-primary {
            background: #ff9f1c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
        }

        /* Header with Analytics Button */
        .header {
            background: #1e1e1e;
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-btn {
            text-decoration: none;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #444;
        }

        .container {
            padding: 20px;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #333;
            text-align: center;
        }

        .stat-val {
            font-size: 1.8em;
            font-weight: bold;
            color: #2ec4b6;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 0.8em;
            color: #888;
        }

        /* History */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-select {
            background: #333;
            color: white;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            outline: none;
        }

        .history-list {
            background: #1e1e1e;
            border-radius: 12px;
            border: 1px solid #333;
            overflow: hidden;
            min-height: 100px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            transition: background 0.2s;
        }

        .history-item:active {
            background: #333;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Scanner */
        .fab-scan {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #ff9f1c;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(255, 159, 28, 0.4);
            cursor: pointer;
            z-index: 1000;
            font-size: 30px;
            border: none;
        }

        /* Modals */
        #scanner-modal,
        #token-display,
        #detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #scanner-modal {
            background: rgba(0, 0, 0, 0.95);
            flex-direction: column;
        }

        #detail-modal {
            background: rgba(0, 0, 0, 0.8);
            z-index: 2500;
        }

        #reader {
            width: 100%;
            max-width: 400px;
            border: 2px solid #555;
            border-radius: 10px;
            overflow: hidden;
        }

        .action-popup {
            display: none;
            background: #2a2a2a;
            padding: 20px;
            border-radius: 12px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            border-left: 5px solid #ff9f1c;
            margin-top: 20px;
        }

        .token-popup {
            background: white;
            color: black;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            z-index: 3000;
            width: 85%;
            max-width: 320px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
        }

        .token-number {
            font-size: 5em;
            font-weight: bold;
            color: #ff9f1c;
            display: block;
            line-height: 1;
            margin: 10px 0;
        }

        .detail-card {
            background: #1e1e1e;
            width: 85%;
            max-width: 350px;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #444;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .scanned-items-list {
            background: #222;
            padding: 10px;
            border-radius: 8px;
            text-align: left;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px dashed #555;
            font-size: 0.9em;
            color: #ffeb3b;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <div id="login-screen">
        <h2 style="color:white; margin-bottom:20px;">Cashier POS</h2>
        <input type="password" id="admin-pass" placeholder="Enter PIN">
        <button class="btn-primary" onclick="checkLogin()">Login</button>
    </div>

    <div id="main-app" style="display:none;">
        <div class="header">
            <div>
                <div style="font-size:0.8em; color:#777;" id="current-date">--</div>
                <h2 style="margin:0; font-size:1.2em; color:#ff9f1c;">Gwalia POS</h2>
            </div>
            <a href="analytics.html" class="header-btn">
                ðŸ“Š Analysis
            </a>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-val">â‚¹<span id="daily-total">0</span></div>
                    <div class="stat-label">Today's Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val" style="color:white;"><span id="last-token">--</span></div>
                    <div class="stat-label">Last Token</div>
                </div>
            </div>

            <div class="section-header">
                <span style="font-weight:bold; color:#ccc;">Recent History</span>
                <select id="history-filter" class="filter-select" onchange="updateHistoryFilter()">
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">Last 7 Days</option>
                </select>
            </div>

            <div class="history-list" id="history-list">
                <div style="padding:20px; text-align:center; color:#555;">Loading...</div>
            </div>
        </div>

        <button class="fab-scan" onclick="openScanner()">ðŸ“·</button>
    </div>

    <div id="scanner-modal">
        <button onclick="closeScanner()"
            style="position:absolute; top:20px; right:20px; background:#333; color:white; border:none; padding:10px; border-radius:5px;">Close
            X</button>
        <div style="color:white; margin-bottom:10px;">Scan QR</div>
        <div id="reader"></div>
        <div id="scan-result" class="action-popup">
            <h3 style="color:white; margin:0;">Order Found</h3>
            <p id="scanned-ref" style="color:#aaa; font-family:monospace; font-size:0.8em;"></p>
            <div id="scanned-items-display" class="scanned-items-list"></div>
            <div style="font-size: 1.5em; font-weight: bold; margin: 10px 0; color:white;">â‚¹<span
                    id="scan-amount">0</span></div>
            <div style="display: flex; gap: 10px;">
                <button onclick="resetScanner()"
                    style="flex:1; padding:10px; border-radius:5px; border:none; background:#444; color:white;">Discard</button>
                <button onclick="generateTokenAndSave()"
                    style="flex:1; padding:10px; border-radius:5px; border:none; background:#2ec4b6; color:white; font-weight:bold;">âœ…
                    Accept</button>
            </div>
        </div>
    </div>

    <div id="token-display" class="token-popup">
        <div style="color:#333;">TOKEN NUMBER</div>
        <span class="token-number" id="big-token-num">0</span>
        <button onclick="document.getElementById('token-display').style.display='none'"
            style="background:#333; color:white; padding:10px 20px; border:none; border-radius:5px;">Done</button>
    </div>

    <div id="detail-modal">
        <div class="detail-card">
            <div
                style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <span style="color:#ff9f1c; font-weight:bold; font-size:1.2em;">Token #<span
                        id="detail-token">--</span></span>
                <button onclick="document.getElementById('detail-modal').style.display='none'"
                    style="background:none; border:none; color:white;">âœ•</button>
            </div>
            <div style="color:#ccc; font-size:0.9em; margin-bottom:15px;">
                <span id="detail-date" style="color:white;">--</span> â€¢ <span id="detail-time"
                    style="color:white;">--</span>
            </div>
            <div style="font-size:0.9em; color:#888;">Items Ordered:</div>
            <div id="detail-items" class="scanned-items-list" style="max-height: 200px;"></div>
            <div
                style="display:flex; justify-content:space-between; margin-top:15px; font-weight:bold; font-size:1.2em;">
                <span>Total</span> <span style="color:#ff9f1c;">â‚¹<span id="detail-total">0</span></span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, onSnapshot, orderBy, limit, getDocs, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGNfaSsDoVEn9e_EEA36J7FbtDG9Zpcww",
            authDomain: "gwalia-canteen-db.firebaseapp.com",
            projectId: "gwalia-canteen-db",
            storageBucket: "gwalia-canteen-db.firebasestorage.app",
            messagingSenderId: "609249581676",
            appId: "1:609249581676:web:9495fd520ba2681ac4d649"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentScannedText = ""; let currentAmount = 0; let html5QrcodeScanner = null; let listUnsubscribe = null;
        let scannedItemsList = [];

        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short' });

        window.checkLogin = function () {
            if (document.getElementById('admin-pass').value === "admin123") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                listenToLiveStats();
                updateHistoryFilter();
            } else { alert("Wrong PIN"); }
        }

        // SCANNER
        window.openScanner = function () {
            document.getElementById('scanner-modal').style.display = 'flex';
            if (!html5QrcodeScanner) {
                html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
                html5QrcodeScanner.render(onScanSuccess);
            }
        }
        window.closeScanner = function () { document.getElementById('scanner-modal').style.display = 'none'; document.getElementById('scan-result').style.display = 'none'; }

        function onScanSuccess(decodedText) {
            document.getElementById('scan-result').style.display = 'block';
            const match = decodedText.match(/TOTAL: â‚¹(\d+)/);
            currentAmount = match ? parseInt(match[1]) : 0;
            currentScannedText = decodedText;

            const lines = decodedText.split('\n');
            document.getElementById('scanned-ref').innerText = lines[0];
            const itemsDiv = document.getElementById('scanned-items-display'); itemsDiv.innerHTML = "";

            // RESET & PARSE ITEMS 
            scannedItemsList = [];
            let isReadingItems = false;

            for (let line of lines) {
                if (line.includes("TOTAL:")) break;
                if (isReadingItems && line.trim() !== "" && !line.includes("---")) {
                    itemsDiv.innerHTML += `<div>${line}</div>`;

                    let name = line.trim();
                    let qty = 1;

                    // Logic to handle "Maggi x2" vs "Tea"
                    const qtyMatch = line.match(/(.+) x(\d+)$/);
                    if (qtyMatch) {
                        name = qtyMatch[1];
                        qty = parseInt(qtyMatch[2]);
                    }
                    scannedItemsList.push({ name: name, qty: qty });
                }
                if (line.includes("----")) isReadingItems = true;
            }
            document.getElementById('scan-amount').innerText = currentAmount;
        }
        window.resetScanner = function () { document.getElementById('scan-result').style.display = 'none'; }

        // --- SMART SAVE (Stock Deduct + Analytics Data) ---
        window.generateTokenAndSave = async function () {
            if (currentAmount === 0) { alert("Error: No Amount found"); return; }

            // 1. SAFETY CHECK
            let stockError = null;
            try {
                const menuSnapshot = await getDocs(collection(db, "menu_items"));
                for (let orderItem of scannedItemsList) {
                    let dbDoc = null;
                    menuSnapshot.forEach(doc => { if (doc.data().name === orderItem.name) dbDoc = doc; });
                    if (dbDoc) {
                        const dbData = dbDoc.data();
                        const currentStock = dbData.stock !== undefined ? dbData.stock : 9999;
                        if (currentStock < orderItem.qty) {
                            stockError = `âš ï¸ INSUFFICIENT STOCK!\n\nItem: ${orderItem.name}\nAvailable: ${currentStock}`;
                            break;
                        }
                    }
                }
            } catch (e) { console.error("Check Error", e); }

            if (stockError) { alert(stockError); return; }

            // 2. DEDUCT STOCK
            if (scannedItemsList.length > 0) {
                const menuSnapshot = await getDocs(collection(db, "menu_items"));
                menuSnapshot.forEach(docSnap => {
                    const itemData = docSnap.data();
                    const scannedItem = scannedItemsList.find(i => i.name === itemData.name);
                    if (scannedItem && itemData.stock < 9000) {
                        updateDoc(doc(db, "menu_items", docSnap.id), {
                            stock: increment(-scannedItem.qty),
                            isAvailable: (itemData.stock - scannedItem.qty) > 0
                        });
                    }
                });
            }

            // 3. GENERATE TOKEN & SAVE FOR ANALYTICS
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const q = query(collection(db, "orders"), where("timestamp", ">=", today), orderBy("timestamp", "desc"), limit(1));
            let newTokenNumber = 101;

            // Flatten list for Analytics (e.g. "Maggi", "Maggi", "Tea")
            let analyticsList = [];
            scannedItemsList.forEach(item => {
                for (let i = 0; i < item.qty; i++) analyticsList.push(item.name);
            });

            try {
                const snap = await getDocs(q);
                if (!snap.empty && snap.docs[0].data().token) newTokenNumber = snap.docs[0].data().token + 1;

                await addDoc(collection(db, "orders"), {
                    token: newTokenNumber,
                    amount: currentAmount,
                    raw_text: currentScannedText,
                    items_list: analyticsList, // Saved for charts!
                    timestamp: serverTimestamp(),
                    status: "paid"
                });

                document.getElementById('scanner-modal').style.display = 'none';
                document.getElementById('token-display').style.display = 'block';
                document.getElementById('big-token-num').innerText = newTokenNumber;
                document.getElementById('scan-result').style.display = 'none';
            } catch (e) { console.error(e); alert(e.message); }
        }

        // LISTENER STATS (Same as before)
        function listenToLiveStats() {
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const q = query(collection(db, "orders"), where("timestamp", ">=", today));
            onSnapshot(q, (snapshot) => {
                let total = 0; let maxToken = 0;
                snapshot.forEach(doc => { const d = doc.data(); total += d.amount; if (d.token > maxToken) maxToken = d.token; });
                document.getElementById('daily-total').innerText = total;
                document.getElementById('last-token').innerText = maxToken > 0 ? maxToken : "--";
            });
        }

        window.updateHistoryFilter = function () {
            const filter = document.getElementById('history-filter').value;
            const start = new Date(); let end = null;
            start.setHours(0, 0, 0, 0);
            if (filter === 'yesterday') { start.setDate(start.getDate() - 1); end = new Date(); end.setHours(0, 0, 0, 0); }
            else if (filter === 'week') { start.setDate(start.getDate() - 7); }
            loadHistory(start, end);
        }

        function loadHistory(startDate, endDate) {
            if (listUnsubscribe) listUnsubscribe();
            let q = endDate
                ? query(collection(db, "orders"), where("timestamp", ">=", startDate), where("timestamp", "<", endDate), orderBy("timestamp", "desc"))
                : query(collection(db, "orders"), where("timestamp", ">=", startDate), orderBy("timestamp", "desc"));

            const listDiv = document.getElementById('history-list');
            listDiv.innerHTML = "<div style='padding:20px;text-align:center;color:#555;'>Loading...</div>";

            listUnsubscribe = onSnapshot(q, (snapshot) => {
                listDiv.innerHTML = "";
                if (snapshot.empty) { listDiv.innerHTML = "<div style='padding:20px;text-align:center;color:#555;'>No orders found</div>"; return; }

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const dateObj = d.timestamp ? d.timestamp.toDate() : new Date();
                    const time = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const dateStr = dateObj.toLocaleDateString();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `<div><div style="font-weight:bold; color:white;">Token #${d.token}</div><div style="font-size:0.8em; color:#777;">${dateStr} â€¢ ${time}</div></div><div style="color:#2ec4b6; font-weight:bold;">+â‚¹${d.amount}</div>`;
                    item.addEventListener('click', () => openDetailModal(d, time, dateStr));
                    listDiv.appendChild(item);
                });
            });
        }

        function openDetailModal(data, time, dateStr) {
            document.getElementById('detail-modal').style.display = 'flex';
            document.getElementById('detail-token').innerText = data.token;
            document.getElementById('detail-time').innerText = time;
            document.getElementById('detail-date').innerText = dateStr;
            document.getElementById('detail-total').innerText = data.amount;
            const lines = data.raw_text.split('\n');
            const itemsDiv = document.getElementById('detail-items'); itemsDiv.innerHTML = "";
            let isReadingItems = false;
            for (let line of lines) {
                if (line.includes("TOTAL:")) break;
                if (isReadingItems && line.trim() !== "" && !line.includes("---")) itemsDiv.innerHTML += `<div>${line}</div>`;
                if (line.includes("----")) isReadingItems = true;
            }
        }
    </script>
</body>

</html>